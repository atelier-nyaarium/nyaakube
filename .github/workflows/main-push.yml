# Uses secrets:
#   DOCKER_PASSWORD
#   DOCKER_USERNAME
#   KUBECONFIG
#   SNYK_TOKEN

name: Push (main)

on:
  push:
    branches:
      - main

  schedule:
    - cron: "0 4 * * 1"

jobs:
  Build:
    uses: ./.github/workflows/_build.yml
    secrets: inherit
    permissions:
      actions: read
      contents: read
    with:
      push: true

  # Push:
  #   needs: Build
  #   uses: ./.github/workflows/_docker-push.yml
  #   secrets: inherit
  #   permissions:
  #     actions: read
  #     contents: read

  Rollout:
    needs: Build
    uses: ./.github/workflows/_k8s-restart.yml
    secrets: inherit
    permissions:
      actions: read
      contents: read

  Trivy:
    needs: Build
    uses: ./.github/workflows/_trivy.yml
    secrets: inherit
    permissions:
      actions: read
      contents: read
      security-events: write

  Dependabot:
    needs: Build
    uses: ./.github/workflows/_approve-dependabot.yml
    secrets: inherit
    permissions:
      actions: read
      contents: read
